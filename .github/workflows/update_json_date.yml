name: Update JSON Date

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  update-json-date:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Update JSON files
      run: |
        # Fetch the base branch for comparison
        BASE_BRANCH=${{ github.event.pull_request.base.ref }}
        HEAD_BRANCH=${{ github.event.pull_request.head.ref }}

        # Fetch the base branch to ensure it's locally available
        git fetch origin $BASE_BRANCH

        # Get the list of changed files between base and head branches
        CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH HEAD)

        echo "Changed files: $CHANGED_FILES"

        # Iterate through changed files
        for FILE in $CHANGED_FILES; do
          echo "In Loop befor if"
          # Check if the file matches the script patterns
          if [[ "$FILE" =~ ^ct/(.*)\\.sh$ ]]; then
            NAME="${BASH_REMATCH[1]}"
          elif [[ "$FILE" =~ ^install/(.*)-install\\.sh$ ]]; then
            NAME="${BASH_REMATCH[1]}"
          if [[ "$FILE" =~ ^json/(.*)\\.json$ ]]; then
            NAME="${BASH_REMATCH[1]}"
          else
            continue
          fi
          echo "After if in loop"
          # Locate the corresponding JSON file
          JSON_FILE="json/${NAME}.json" # Adjust the path as necessary

          if [[ -f "$JSON_FILE" ]]; then
            echo "Updating date_created in $JSON_FILE"

            # Use jq to update the date_created field
            jq --arg date "$(date +%Y-%m-%d)" '.date_created = $date' "$JSON_FILE" > tmp.json && mv tmp.json "$JSON_FILE"
          else
            echo "JSON file $JSON_FILE not found"
          fi
        done


    - name: Push changes with API keys
      env:
        JSON_API_ID: ${{ secrets.JSON_API_ID }}
        JSON_API_KEY: ${{ secrets.JSON_API_KEY }}
      run: |
        git remote set-url origin https://$JSON_API_ID:$JSON_API_KEY@github.com/${{ github.repository }}.git
        git push
