name: Update JSON Date

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  update-json-date:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code 
        uses: actions/checkout@v4
      - name: Update JSON
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: |
          
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})

          
          for FILE in $CHANGED_FILES; do
            
            if [[ "$FILE" =~ ^ct/(.*)\.sh$ ]]; then
              NAME="${BASH_REMATCH[1]}"
            elif [[ "$FILE" =~ ^install/(.*)-install\.sh$ ]]; then
              NAME="${BASH_REMATCH[1]}"
            else
             if [[ "$FILE" =~ ^json/(.*)\.json$ ]]; then
              NAME="${BASH_REMATCH[1]}"
            else
              continue
            fi

            
            JSON_FILE="json/${NAME}.json" # Adjust the path as necessary

            if [[ -f "$JSON_FILE" ]]; then
              echo "Updating date_created in $JSON_FILE"

              
              jq --arg date "$(date +%Y-%m-%d)" '.date_created = $date' "$JSON_FILE" > tmp.json && mv tmp.json "$JSON_FILE"
            else
              echo "JSON file $JSON_FILE not found"
            fi
          done

      - name: Push changes with API keys
        env:
          JSON_API_ID: ${{ secrets.JSON_API_ID }}
          JSON_API_KEY: ${{ secrets.JSON_API_KEY }}
        run: |
          git remote set-url origin https://$JSON_API_ID:$JSON_API_KEY@github.com/${{ github.repository }}.git
          git push
