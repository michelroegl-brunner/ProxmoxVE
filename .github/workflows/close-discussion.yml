name: Close Discussion on PR Merge

on:
  pull_request:
    types: [closed]  # Trigger only when the PR is closed

jobs:
  close-discussion:
    runs-on: ubuntu-latest

    steps:
    - name: Check if PR is merged
      if: github.event.pull_request.merged == true
      run: |
        # Extract the discussion ID from the PR body
        pr_body="${{ github.event.pull_request.body }}"
        discussion_id=$(echo "$pr_body" | grep -oP '#\d+' | sed 's/#//')

        # If discussion_id is found, close the discussion using GitHub GraphQL API
        if [ -n "$discussion_id" ]; then
          echo "Discussion ID found: #$discussion_id"
          # Set GitHub Token to authenticate API requests
          token="${{ secrets.GITHUB_TOKEN }}"
          
          # GraphQL query to close the discussion
           graphql_query=$(echo "{\"query\": \"mutation { updateDiscussion(input: {id: \\\"$discussion_id\\\", state: CLOSED}) { discussion { id title state } } }\"}")         )

          # Make the GraphQL request to close the discussion
          curl -X POST \
            -H "Authorization: Bearer $token" \
            -H "Content-Type: application/json" \
            -d "$graphql_query" \
            "https://api.github.com/graphql"
          
        else
          echo "No discussion ID found in the PR body."
        fi
